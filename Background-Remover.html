<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Background Remover (U²Net WASM) — tools4.fun</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<style>
  body { background: #f6f7fb; }
  .drop-area {
    border: 2px dashed #cbd5e1;
    border-radius: 8px;
    padding: 20px;
    text-align: center;
    background: #fff;
    cursor: pointer;
  }
  .drop-area.dragover {
    border-color: #6c7ae0;
    box-shadow: 0 6px 18px rgba(108,122,224,0.08);
  }
  canvas { max-width: 100%; display: block; margin: 0 auto; }
  .small-muted { font-size: .9rem; color: #6b7280; }
</style>
</head>
<body>
<div class="container py-4">
  <h4 class="mb-3">🪄 Background Remover (Offline)</h4>
  <div class="row g-3">
    <div class="col-lg-6">
      <div id="drop" class="drop-area">
        <p><strong>Drop an image here</strong> or click to select</p>
        <p class="small-muted">All processing happens locally. No upload required.</p>
        <input type="file" id="fileInput" accept="image/*" style="display:none;">
      </div>
      <div class="mt-3 d-flex gap-2 flex-wrap">
        <button id="removeBtn" class="btn btn-primary" disabled>Remove Background</button>
        <button id="downloadBtn" class="btn btn-success" disabled>Download PNG</button>
        <button id="resetBtn" class="btn btn-outline-secondary" disabled>Reset</button>
      </div>
      <div class="mt-3 small-muted" id="status">Model loading...</div>
    </div>
    <div class="col-lg-6 text-center">
      <canvas id="canvas"></canvas>
    </div>
  </div>
</div>

<!-- ONNX runtime -->
<script src="https://cdn.jsdelivr.net/npm/onnxruntime-web/dist/ort.wasm.min.js"></script>

<script>
const statusEl = document.getElementById("status");
const fileInput = document.getElementById("fileInput");
const drop = document.getElementById("drop");
const canvas = document.getElementById("canvas");
const ctx = canvas.getContext("2d");
const removeBtn = document.getElementById("removeBtn");
const downloadBtn = document.getElementById("downloadBtn");
const resetBtn = document.getElementById("resetBtn");

let imageBitmap = null;
let resultBlob = null;
let session = null;

// --- Load model ---
(async () => {
  try {
    statusEl.textContent = "Loading U²Net model (~30 MB)... please wait ⏳";
    session = await ort.InferenceSession.create(
      "https://huggingface.co/briaai/BRIA-RMBG-1.4/resolve/main/u2net.onnx"
    );
    statusEl.textContent = "Model loaded ✅. Drop image to start.";
  } catch (e) {
    console.error(e);
    statusEl.textContent = "Error loading model ❌";
  }
})();

// --- File Handling ---
drop.addEventListener("click", () => fileInput.click());
drop.addEventListener("dragover", e => { e.preventDefault(); drop.classList.add("dragover"); });
drop.addEventListener("dragleave", () => drop.classList.remove("dragover"));
drop.addEventListener("drop", e => {
  e.preventDefault();
  drop.classList.remove("dragover");
  if (e.dataTransfer.files.length) loadImage(e.dataTransfer.files[0]);
});
fileInput.addEventListener("change", e => {
  if (e.target.files.length) loadImage(e.target.files[0]);
});

async function loadImage(file) {
  if (!file.type.startsWith("image/")) return alert("Please select an image.");
  const blobURL = URL.createObjectURL(file);
  imageBitmap = await createImageBitmap(file);
  const maxW = 512;
  const scale = Math.min(1, maxW / imageBitmap.width);
  canvas.width = imageBitmap.width * scale;
  canvas.height = imageBitmap.height * scale;
  ctx.drawImage(imageBitmap, 0, 0, canvas.width, canvas.height);
  removeBtn.disabled = false;
  resetBtn.disabled = false;
  downloadBtn.disabled = true;
  statusEl.textContent = `Loaded: ${file.name}`;
}

// --- Remove background using U²Net ---
removeBtn.addEventListener("click", async () => {
  if (!session || !imageBitmap) return;
  removeBtn.disabled = true;
  statusEl.textContent = "Processing image... 🧠";

  const w = canvas.width, h = canvas.height;
  const inputTensor = await prepareTensor(canvas, w, h);

  const feeds = { "input": inputTensor };
  const results = await session.run(feeds);
  const mask = results[Object.keys(results)[0]].data;

  const output = ctx.getImageData(0, 0, w, h);
  for (let i = 0; i < w * h; i++) {
    const alpha = Math.min(255, Math.max(0, mask[i] * 255));
    output.data[i * 4 + 3] = alpha;
  }
  ctx.putImageData(output, 0, 0);

  await new Promise(r => canvas.toBlob(b => { resultBlob = b; r(); }, "image/png"));
  downloadBtn.disabled = false;
  removeBtn.disabled = false;
  statusEl.textContent = "Done ✅ — Background removed!";
});

async function prepareTensor(canvas, w, h) {
  const img = ctx.getImageData(0, 0, w, h);
  const data = Float32Array.from(img.data).filter((_, i) => (i + 1) % 4 !== 0);
  for (let i = 0; i < data.length; i++) data[i] = data[i] / 255.0;
  return new ort.Tensor("float32", data, [1, 3, h, w]);
}

// --- Download ---
downloadBtn.addEventListener("click", () => {
  if (!resultBlob) return;
  const url = URL.createObjectURL(resultBlob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "bg-removed.png";
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
});

// --- Reset ---
resetBtn.addEventListener("click", () => {
  ctx.clearRect(0,0,canvas.width,canvas.height);
  fileInput.value = "";
  imageBitmap = null;
  resultBlob = null;
  removeBtn.disabled = true;
  downloadBtn.disabled = true;
  resetBtn.disabled = true;
  statusEl.textContent = "Model ready — drop an image to start.";
});
</script>
</body>
</html>

